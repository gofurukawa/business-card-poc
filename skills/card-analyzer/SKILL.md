# Card Analyzer Skill

名刺画像を解析し、レイアウト JSON を生成するスキルです。

## 概要

Claude の Vision 機能を使用して名刺画像を解析し、`schemas/card_layout.schema.json` に準拠した JSON を生成します。

## 重要: 反復改善プロセス

**このスキルでは、最低3回の「生成→測定→調整」サイクルを必須とします。**

初回の解析で完璧な再現は困難です。必ず以下のサイクルを繰り返してください：

```
┌─────────────────────────────────────────────────────────────┐
│  Phase 1: 初回解析・生成                                      │
│  ├─ 画像を解析し JSON を生成                                  │
│  ├─ backup_version.sh で v01 を保存                          │
│  ├─ measure_positions.py で位置を定量測定 ← 必須              │
│  └─ 元画像と v01 の誤差を数値で確認                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Phase 2: フォント種類の調整                                   │
│  ├─ 明朝/ゴシックの判定を修正                                 │
│  ├─ backup_version.sh で v02 を保存                          │
│  ├─ measure_positions.py で改善を確認 ← 必須                  │
│  └─ 誤差が縮小したか数値で確認                                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Phase 3: サイズ・位置の微調整                                 │
│  ├─ フォントサイズ、ウェイト、位置を調整                       │
│  ├─ backup_version.sh で v03 を保存                          │
│  ├─ measure_positions.py で精度評価 ← 必須                    │
│  └─ 誤差 ±0.5mm 以内になるまで繰り返し                        │
└─────────────────────────────────────────────────────────────┘
```

### 位置測定スクリプトの使用（必須）

**各 Phase で必ず `measure_positions.py` を実行し、定量的に精度を評価してください。**

```bash
# 元画像と生成画像を比較（毎回必ず実行）
python3 scripts/measure_positions.py input/元画像.png output/backup/analyzed_card_vXX.png
```

**完了基準**: 以下の条件を満たすまで反復を続ける
- X位置の最大誤差: ±0.5mm 以内
- Y位置の最大誤差: ±0.5mm 以内
- スクリプトが「✓ 位置精度は許容範囲内」と表示

---

## Step 1: 画像の基準サイズを確認

名刺の標準サイズは **91mm × 55mm** です。画像内の要素位置を正確に推定するため、以下の計算式を使用します：

```
x_mm = (要素の左端位置 / 画像幅) × 91
y_mm = (要素の上端位置 / 画像高さ) × 55
```

**重要**: 位置は要素の**左上角**を基準とします。

---

## Step 2: 画像要素を識別

名刺画像内のグラフィック要素（ロゴ、写真、装飾帯など）を識別します。

#### 識別する画像要素

| 要素タイプ | 識別のヒント | 切り出し方針 |
|-----------|-------------|-------------|
| 会社ロゴ | 上部や角に配置、テキストと異なるグラフィック | 領域全体を1つの画像として切り出し |
| 写真エリア | グレーや色付きの四角形領域 | 領域全体を切り出し |
| 装飾帯・ライン | 画面端の色付き帯、横線など | 帯全体を1つの画像として切り出し |
| アイコン | 電話、メール等の小さいマーク | 必要に応じて切り出し |

**切り出しの原則**:
- 画像要素は**細かくスライスせず、領域全体を1つの画像**として切り出す
- ロゴと装飾帯が連続している場合も、それぞれ独立した画像として扱う
- 切り出した画像は `assets/` ディレクトリに保存

---

## Step 3: テキスト要素を識別

名刺画像を観察し、以下の要素を識別します：

| 要素 | 識別のヒント |
|-----|-------------|
| 氏名（漢字） | 最も大きい日本語テキスト。通常は中央付近 |
| 氏名（ふりがな/ローマ字） | 氏名の上または下にある小さいテキスト |
| 役職 | 氏名の近くにある肩書き（部長、課長、エンジニア等） |
| 部署名 | 会社名の下、または役職の近く |
| 会社名 | 上部に配置されることが多い。ロゴと併記の場合も |
| 郵便番号 | 〒マーク付き、または 000-0000 形式 |
| 住所 | 都道府県から始まる住所 |
| 電話番号 | TEL:、Tel:、電話 などのラベル付き |
| FAX番号 | FAX:、Fax: などのラベル付き |
| メールアドレス | @ を含むテキスト |
| URL | http:// または www. で始まるテキスト |
| 資格・肩書 | 「○○士」「○○検定会員」など |

---

## Step 4: フォント種類の判定（重要）

### 明朝体 vs ゴシック体の判定基準

フォント種類の判定は**最も間違いやすいポイント**です。以下の基準を厳密に適用してください。

#### ゴシック体 (gothic) の特徴

```
特徴:
├─ 線の太さが均一（縦線も横線も同じ太さ）
├─ ハネ・ハライがない、または目立たない
├─ 角ばった印象
└─ サンセリフ体（英字の場合）

該当フォント例: Noto Sans JP, ヒラギノ角ゴ, 游ゴシック
```

**ゴシック体の視覚的特徴**:
```
 ┌───┐
 │田│ ← 縦線と横線が同じ太さ
 └───┘
```

#### 明朝体 (mincho) の特徴

```
特徴:
├─ 横線が細く、縦線が太い
├─ ハネ・ハライがある（特に「はらい」部分で顕著）
├─ 線の終端に「うろこ」がある
└─ セリフ体（英字の場合）

該当フォント例: Noto Serif JP, ヒラギノ明朝, 游明朝
```

**明朝体の視覚的特徴**:
```
 ┌───┐
 │田│ ← 横線が細く、縦線が太い
 └───┘    線の終端に装飾がある
```

### フォント判定の手順（各要素を個別に判定）

**重要**: パターンに頼らず、**各要素の文字を個別に観察**して判定してください。

#### 判定に使う文字の選び方

以下の漢字は明朝/ゴシックの違いが分かりやすいです：

| 文字 | 観察ポイント |
|------|-------------|
| 「田」「日」「目」 | 横線と縦線の太さの違い |
| 「会」「合」「今」 | 「はらい」部分の形状 |
| 「東」「京」「都」 | 線の終端の「うろこ」の有無 |
| 「株」「式」 | ハネの有無と形状 |

#### 判定手順

```
各テキスト要素について、以下を実行:

1. 要素内の漢字を1文字選ぶ（上記の判定しやすい文字を優先）

2. その文字の「横線」と「縦線」を比較
   ├─ 同じ太さ → gothic の可能性が高い
   └─ 横線が細く縦線が太い → mincho の可能性が高い

3. 線の終端を確認
   ├─ 装飾（うろこ）がない → gothic
   └─ 装飾（うろこ）がある → mincho

4. 「はらい」部分を確認（「会」「人」「大」など）
   ├─ 直線的で太さが均一 → gothic
   └─ 先端に向かって細くなる → mincho
```

#### 各要素を独立して判定する

```
□ 会社名     → 「株」「式」「会」「社」の線を観察 → gothic or mincho?
□ 部署名     → 部署名内の漢字を観察 → gothic or mincho?
□ 氏名（漢字）→ 氏名の漢字を観察 → gothic or mincho?
□ 役職       → 役職内の漢字/カタカナを観察 → gothic or mincho?
□ 住所       → 「東」「京」「都」などを観察 → gothic or mincho?
```

**注意**: 要素ごとにフォントが異なる場合があります。「氏名だけ明朝」「全てゴシック」「全て明朝」など、様々なパターンがあるため、**必ず各要素を個別に判定**してください。

#### 英数字・カタカナの判定

| 文字種 | 判定方法 |
|--------|----------|
| 英字 | セリフ（飾り）の有無で判定。セリフあり→mincho相当、なし→gothic相当 |
| 数字 | 同上 |
| カタカナ | 線の太さの均一性で判定。ただし漢字より判別が難しい |

#### 判定に迷った場合

1. **両方で生成して比較**: gothic と mincho の両方で生成し、元画像と見比べる
2. **別の文字で再確認**: 判定しやすい文字が他にないか探す
3. **横線に注目**: 最も分かりやすい違いは「横線の太さ」

---

## Step 5: フォントサイズ・ウェイトの推定

### サイズ推定 (size_pt)

| 要素タイプ | 推定サイズ | 備考 |
|-----------|-----------|------|
| 氏名（漢字） | 12-16 pt | 最も大きい要素 |
| 会社名・支店名 | 8-11 pt | 氏名より小さい |
| 役職・部署 | 7-9 pt | 中程度 |
| 連絡先（住所、電話等） | 5-7 pt | 小さめ |
| 注釈・補足 | 4-6 pt | 最も小さい |

### 重要: 小数値を積極的に使用する

**整数値に丸めず、小数値を使って精密に推定してください。**

```
刻み幅の目安:
─────────────────────────
大きいフォント（10pt以上）: 0.5pt 刻み（例: 14pt, 13.5pt, 13pt）
小さいフォント（10pt未満）: 0.1pt 刻み（例: 6.5pt, 6.4pt, 6.3pt）

良い例: 14.5pt, 8.5pt, 6.3pt
悪い例: 常に 14pt, 8pt, 6pt のような整数のみ
```

小数値を使うことで、微妙なサイズ差を表現でき、元画像により近い再現が可能になります。
特に小さい文字（連絡先など）は 0.1pt の差が見た目に影響するため、精密に指定してください。

### 重要: サイズ推定の注意点

Vision で画像を解析すると、フォントサイズを**実際より大きく見積もる傾向**があります。

**推定バイアスの傾向**:
- 大きいフォントほど過大評価しやすい
- 視覚的なインパクトに引きずられやすい

**対策: 控えめに推定する**:
```
視覚的印象 → 推定値の目安
─────────────────────────
「かなり大きい」 → 12-14 pt（16pt以上にはしない）
「大きめ」       → 9-11 pt
「普通」         → 7-8 pt
「小さい」       → 6 pt
「とても小さい」 → 5 pt 以下
```

**検証方法**:
初回生成後に元画像と比較し、生成画像のテキストが大きすぎる場合は 0.1-0.5pt 下げて再生成

### ウェイト (weight)

| 見た目 | weight | 使用例 |
|-------|--------|--------|
| 細い線 | `light` | 補足情報 |
| 標準的な太さ | `regular` | 連絡先、住所 |
| 太い線、強調 | `bold` | 氏名、会社名、役職 |

**判定のポイント**:
- 氏名は通常 `bold`
- 役職も `bold` の場合が多い
- 連絡先は `regular`

### 色 (color)

| 見た目 | color |
|-------|-------|
| 黒 | `#000000` |
| 濃いグレー | `#333333` |
| グレー | `#666666` |
| 薄いグレー | `#999999` |
| 紺色 | `#1a2e6e` |

---

## Step 6: 位置の推定

### 位置計算の手順

1. **画像全体に対する要素の相対位置を測定**
   - 要素の左端が画像幅の何%の位置にあるか
   - 要素の上端が画像高さの何%の位置にあるか

2. **mm単位に変換**
   ```
   x_mm = (水平位置%) × 91 / 100
   y_mm = (垂直位置%) × 55 / 100
   ```

3. **小数値を積極的に使用**（0.5刻みで精密に指定）

### 重要: 小数値を積極的に使用する

**整数値に丸めず、小数値（0.5刻み）を使って精密に推定してください。**

```
良い例: x_mm: 10.5, y_mm: 8.5
悪い例: 常に x_mm: 10, y_mm: 8 のような整数のみ
```

位置の微調整では 0.5mm の差が見た目に影響します。元画像に近づけるために、小数値を恐れずに使ってください。

### 重要: 位置推定の注意点

Vision で画像を解析すると、要素の位置を**左上寄りに見積もる傾向**があります。

**推定バイアスの傾向**:
- 左端・上端に近い要素ほど過小評価しやすい
- 余白を実際より狭く感じやすい

**対策: 余白を意識する**:
```
一般的な名刺の余白目安:
─────────────────────────
左余白: 8-12mm が一般的（5mm以下は稀）
上余白: 6-10mm が一般的（5mm以下は稀）
右余白: 5-10mm
下余白: 4-8mm
```

**検証ポイント**:
- 初回推定で x_mm < 8 や y_mm < 6 になった場合、実際には 2-3mm 大きい可能性がある
- 右下にある要素（email等）は比較的正確に推定できることが多い
- 生成画像で印刷領域が広すぎる（テキストが端に寄りすぎ）場合は、位置を調整

### 配置 (align) の判断

- `left`: 左揃え（最も一般的）
- `center`: 中央揃え（会社名や氏名で使用されることがある）
- `right`: 右揃え（連絡先情報で使用されることがある）

### 重要: Y位置のアセンダー補正

**Pillow の `draw.text()` はフォントのアセンダー（上部余白）を含む位置に描画するため、元画像から測定した Y 位置をそのまま使用すると、生成画像のテキストが下にずれます。**

```
フォントの構造:
─────────────────────────
  ┌─ アセンダー（上部余白）
  │  ← draw.text() の y 位置はここを基準
  ├─ 文字本体（キャップハイト）
  │  ← 実際に見える文字の上端
  └─ ディセンダー（下部余白）
```

**補正の目安**:
```
フォントサイズごとの Y 位置補正値:
─────────────────────────────────
大きいフォント（12pt以上）: 約 1.0〜1.5mm 上に補正
中程度フォント（8-11pt）:  約 0.8〜1.0mm 上に補正
小さいフォント（7pt以下）:  約 0.5〜0.8mm 上に補正
```

**実践的な調整手順**:

1. 元画像から文字の**上端**位置を測定（例: 9.1mm）
2. 初回生成で Y 位置をそのまま使用して生成
3. 生成画像と元画像を比較し、ずれ量を測定（例: +1.1mm 下にずれ）
4. JSON の y_mm を補正（例: 9.1mm → 8.0mm）
5. 再生成して確認

**位置測定スクリプト**: `scripts/measure_positions.py`

```bash
# 単一画像の測定
python3 scripts/measure_positions.py input/card.png

# 元画像と生成画像を比較
python3 scripts/measure_positions.py input/original.png output/generated.png
```

出力例:
```
=== 位置比較 ===

No.   元X      生成X    X差      元Y      生成Y    Y差      元高   生成高 高差
--------------------------------------------------------------------------------
1     10.1     10.1     +0.0   9.1      9.0      -0.1   2.9    2.8    -0.1
2     10.1     10.1     +0.0   14.8     14.7     -0.1   2.1    2.0    -0.1
...

=== 精度評価 ===
X位置の最大誤差: 0.08mm
Y位置の最大誤差: 0.08mm
高さの最大誤差:  0.17mm

✓ 位置精度は許容範囲内（±0.5mm以内）です
```

---

## Step 7: JSON 出力と初回生成

### 出力テンプレート

```json
{
  "metadata": {
    "name": "analyzed_card",
    "version": "1.0.0",
    "description": "名刺画像から解析して生成"
  },
  "card": {
    "width_mm": 91,
    "height_mm": 55,
    "background": "#FFFFFF"
  },
  "elements": [
    {
      "id": "company_name",
      "type": "text",
      "content": "{{COMPANY_NAME}}",
      "position": { "x_mm": 10, "y_mm": 8 },
      "font": {
        "category": "gothic",
        "size_pt": 9,
        "weight": "regular",
        "color": "#333333"
      },
      "align": "left"
    }
  ]
}
```

**テンプレートの値について**:
- 位置 `x_mm: 10, y_mm: 8` は一般的な左上配置の目安
- サイズ `9pt` は会社名の標準的なサイズ
- これらは初期値であり、画像に応じて調整が必要

### 要素ID命名規則

| 要素 | id | プレースホルダー |
|-----|-----|-----------------|
| 会社名 | `company_name` | `{{COMPANY_NAME}}` |
| 部署名 | `department` | `{{DEPARTMENT}}` |
| 氏名（漢字） | `name_kanji` | `{{NAME_KANJI}}` |
| 氏名（ローマ字） | `name_romaji` | `{{NAME_ROMAJI}}` |
| 役職 | `title` | `{{TITLE}}` |
| 郵便番号 | `postal_code` | `〒{{POSTAL_CODE}}` |
| 住所 | `address` | `{{ADDRESS}}` |
| 電話番号 | `phone` | `TEL: {{PHONE}}` |
| メール | `email` | `{{EMAIL}}` |

---

## Step 8: 反復改善（必須）

### 必須ワークフロー

**初回生成後、必ず以下の2つのスクリプトを使用して比較・調整を行います。**

1. `backup_version.sh` - バージョン管理付き画像生成
2. `measure_positions.py` - 位置精度の定量測定 **← 毎回必須**

### Phase 1: 初回生成と測定

```bash
# 1. 初回生成 (v01)
./scripts/backup_version.sh templates/analyzed_card.json \
  --set COMPANY_NAME="株式会社サンプル" \
  --set DEPARTMENT="技術部" \
  --set NAME_KANJI="山田 太郎" \
  --set NAME_ROMAJI="Taro Yamada" \
  --set TITLE="シニアエンジニア" \
  --set POSTAL_CODE="100-0001" \
  --set ADDRESS="東京都千代田区..." \
  --set PHONE="03-1234-5678" \
  --set EMAIL="yamada@example.com"

# 2. 位置測定（必須）← これを必ず実行
python3 scripts/measure_positions.py input/元画像.png output/backup/analyzed_card_v01.png
```

**測定結果の読み方**:
```
=== 精度評価 ===
X位置の最大誤差: 2.5mm  ← この値を確認
Y位置の最大誤差: 3.1mm  ← この値を確認

⚠ 位置精度が許容範囲外です。調整が必要です
```

### Phase 2以降: 測定→調整→再測定

```bash
# 1. JSON を修正（位置、サイズ、フォント等）

# 2. 新バージョン生成
./scripts/backup_version.sh templates/analyzed_card.json --set ...

# 3. 位置測定（必須）← 改善を数値で確認
python3 scripts/measure_positions.py input/元画像.png output/backup/analyzed_card_v02.png

# 4. 誤差が縮小したか確認
#    - 前回: X誤差 2.5mm, Y誤差 3.1mm
#    - 今回: X誤差 1.2mm, Y誤差 1.5mm → 改善している ✓
```

### 比較チェックリスト

各バージョンで以下を確認します：

```
□ 位置測定スクリプトの実行（必須）
  □ measure_positions.py を実行したか？
  □ X位置の最大誤差は ±0.5mm 以内か？
  □ Y位置の最大誤差は ±0.5mm 以内か？
  □ 「✓ 位置精度は許容範囲内」と表示されたか？

□ フォント種類
  □ 氏名: 明朝 or ゴシック？
  □ 会社名: 明朝 or ゴシック？
  □ その他: 期待通りか？

□ フォントサイズ（過大評価に注意、小数値を活用）
  □ 生成画像のテキストが元画像より大きくないか？
  □ 氏名が最も大きいか？
  □ 会社名と氏名のバランスは？
  □ 連絡先は小さすぎ/大きすぎないか？
  → 大きい文字の微調整: 0.5pt 刻み（例: 14pt → 13.5pt）
  → 小さい文字の微調整: 0.1pt 刻み（例: 6.5pt → 6.4pt）

□ フォントウェイト
  □ 氏名は bold か？
  □ 役職は bold か regular か？

□ 位置（測定結果に基づいて調整）
  □ X差がプラスの場合: x_mm を減らす
  □ X差がマイナスの場合: x_mm を増やす
  □ Y差がプラスの場合: y_mm を減らす
  □ Y差がマイナスの場合: y_mm を増やす
  → 微調整: 0.5mm 刻みで調整（例: 10mm → 10.5mm）
```

### 調整サイクル（定量的判断）

```
1. v01 生成
   ↓ measure_positions.py 実行
   ↓ 誤差確認: X=2.5mm, Y=3.1mm → 許容範囲外
   ↓ フォント種類も違う → JSON修正

2. v02 生成
   ↓ measure_positions.py 実行
   ↓ 誤差確認: X=1.2mm, Y=1.5mm → 改善したがまだ範囲外
   ↓ サイズ・位置を微調整 → JSON修正

3. v03 生成
   ↓ measure_positions.py 実行
   ↓ 誤差確認: X=0.4mm, Y=0.3mm → 許容範囲内 ✓
   ↓ 「✓ 位置精度は許容範囲内」表示 → 完了
```

### バージョン比較コマンド

```bash
# 位置精度を定量測定（毎回必須）
python3 scripts/measure_positions.py input/original.png output/backup/analyzed_card_v03.png

# Mac で2つの画像を並べて視覚比較
open output/backup/analyzed_card_v02.png output/backup/analyzed_card_v03.png

# 元画像と最新版を視覚比較
open input/original.png output/backup/analyzed_card_v03.png
```

---

## 注意事項

1. **最低3回の反復を必須とする**: 初回で完璧な再現は困難です

2. **measure_positions.py を毎回実行**: 目視ではなく数値で精度を判断してください
   - 完了基準: 誤差 ±0.5mm 以内
   - 「✓ 位置精度は許容範囲内」が表示されるまで調整を続ける

3. **フォント判定は慎重に**: 明朝/ゴシックの違いが再現性に大きく影響します

4. **backup_version.sh を必ず使用**: 調整履歴を残すことで、どの変更が効果的だったか確認できます

5. **プライバシー配慮**: 実際の個人情報は出力せず、必ずプレースホルダー形式 `{{KEY}}` で出力

6. **画像ファイルのパス**: テンプレートJSONからの相対パス（`../assets/xxx.png`）で指定

---

## 画像要素の処理方式（推奨: 背景画像方式）

名刺画像内のロゴや装飾を扱う方式は2つあります。**位置精度を優先する場合は背景画像方式を推奨**します。

### 方式の比較

| アプローチ | メリット | デメリット |
|-----------|----------|-----------|
| **背景画像方式（推奨）** | 位置ズレなし、シンプル、高精度 | ロゴ位置は固定、テキスト配置のみ変更可能 |
| **画像切り出し方式** | 要素を自由に配置可能 | 切り出し精度・配置位置のズレが発生しやすい |

### どちらを選ぶか

- **テキストのみ変更したい、位置精度を優先** → **背景画像方式（推奨）**
- **ロゴや装飾の位置を変更したい** → 画像切り出し方式

---

## 背景画像方式（推奨）

テキストを除去して背景画像として使用する方法です。位置精度が高く、シンプルに実装できます。

### 1. 背景画像を生成

`scripts/remove_text.py` を使用してテキスト領域を除去します。

```bash
# 手動で領域を指定（推奨）
python3 scripts/remove_text.py input/card.png -o assets/card_background.png \
  --region 0.28,0.08,0.98,0.98

# 自動検出モード（白背景上のテキストを検出）
python3 scripts/remove_text.py input/card.png -o assets/card_background.png \
  --auto --exclude 0,0,0.28,1.0
```

**オプション:**
- `--region x1,y1,x2,y2`: 塗りつぶす領域（割合 0.0-1.0）
- `--auto`: 白背景上のテキストを自動検出
- `--exclude x1,y1,x2,y2`: 自動検出時に除外する領域（ロゴ等）
- `--mask PATH`: デバッグ用マスク画像を出力

### 2. JSON で背景画像を指定

```json
{
  "card": {
    "width_mm": 91,
    "height_mm": 55,
    "background_image": "../assets/card_background.png"
  },
  "elements": [
    {
      "id": "name_kanji",
      "type": "text",
      "content": "{{NAME_KANJI}}",
      "position": { "x_mm": 32, "y_mm": 20 },
      "font": { "category": "gothic", "size_pt": 14, "weight": "bold" }
    }
  ]
}
```

---

## 画像切り出し方式（代替）

ロゴや装飾の位置を変更したい場合に使用します。

### Python で切り出し

```python
from PIL import Image

img = Image.open('input/card.png')
w, h = img.size

# 例: 上部ロゴ（左上の25%×12%の領域）
logo = img.crop((0, 0, int(w * 0.25), int(h * 0.12)))
logo.save('assets/company_logo.png')

# 例: 下部装飾帯（下から8%の領域、全幅）
stripe = img.crop((0, int(h * 0.92), w, h))
stripe.save('assets/bottom_stripe.png')
```

### 単色の装飾は生成も可

```python
from PIL import Image

# 91mm × 4mm @300dpi の青い帯
stripe = Image.new('RGB', (1075, 47), '#1a2e6e')
stripe.save('assets/bottom_stripe.png')
```
